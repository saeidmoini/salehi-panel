- name: Ensure project root exists
  file:
    path: "{{ project_root }}"
    state: directory
    mode: '0755'
    owner: "{{ project_user }}"
    group: "{{ project_group }}"

- name: Checkout repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ project_root }}"
    version: HEAD
    force: yes

- name: Ensure ownership on project root
  file:
    path: "{{ project_root }}"
    state: directory
    recurse: true
    owner: "{{ project_user }}"
    group: "{{ project_group }}"

- name: Ensure venv exists
  command: python3 -m venv {{ venv_path }}
  args:
    creates: "{{ venv_path }}/bin/activate"

- name: Install backend dependencies
  pip:
    requirements: "{{ backend_dir }}/requirements.txt"
    virtualenv: "{{ venv_path }}"
    virtualenv_site_packages: false

- name: Render backend .env
  template:
    src: backend_env.j2
    dest: "{{ backend_dir }}/.env"
    mode: '0600'

- name: Run Alembic migrations
  command: "{{ venv_path }}/bin/alembic upgrade head"
  args:
    chdir: "{{ backend_dir }}"
  environment:
    DATABASE_URL: "{{ database_url }}"

- name: Run Django migrate (when framework=django)
  when: backend_framework == "django"
  command: "{{ venv_path }}/bin/python manage.py migrate"
  args:
    chdir: "{{ django_manage_dir }}"

- name: Collect static (Django, when framework=django)
  when: backend_framework == "django"
  command: "{{ venv_path }}/bin/python manage.py collectstatic --noinput"
  args:
    chdir: "{{ django_manage_dir }}"

- name: Install systemd unit
  template:
    src: gunicorn.service.j2
    dest: "/etc/systemd/system/{{ project_name }}.service"
    mode: '0644'

- name: Reload and enable service
  systemd:
    name: "{{ project_name }}"
    enabled: true
    state: restarted
    daemon_reload: true
